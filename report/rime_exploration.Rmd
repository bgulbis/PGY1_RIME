---
title: "Assessment of RIME Scores"
author: "Brian Gulbis"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
    code_folding: hide
    fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE)
```

```{r, message=FALSE}
library(tidyverse)
library(readxl)
library(stringr)
library(forcats)
library(themebg)
library(Hmisc)

rime <- list.files("../data/raw", "rime-scores", full.names = TRUE) %>%
    map_df(read_excel) 
```

```{r, fig.cap="Composite change in RIME scores over time", message=FALSE}
rime %>%
    group_by(resident) %>%
    mutate(rotation_number = TRUE,
           rotation_number = cumsum(rotation_number)) %>%
    gather(skill, score, reporter:educator) %>%
    filter(!is.na(score)) %>%
    ggplot(aes(x = rotation_number, y = score, color = fct_inorder(skill))) +
    geom_smooth(se = FALSE) +
    scale_x_continuous("Rotation Number", breaks = 1:10) +
    scale_color_brewer("", palette = "Dark2", labels = capitalize) +
    ylab("RIME Score") +
    theme_bg() 
```

```{r, fig.cap="Distribution of RIME Scores by Role"}
rime %>%
    gather(skill, score, reporter:educator) %>%
    filter(!is.na(score)) %>%
    dmap_at("skill", str_to_title) %>%
    dmap_at("skill", fct_inorder) %>%
    ggplot(aes(x = skill, y = score)) +
    geom_boxplot() +
    xlab("") +
    ylab("RIME Score") +
    theme_bg(xticks = FALSE)
```

```{r, fig.width=8, fig.height=7, fig.cap="Distribution of RIME scores by preceptor"}
x <- rime %>%
    gather(skill, score, reporter:educator) %>%
    filter(!is.na(score)) %>%
    dmap_at("skill", fct_inorder) %>%
    dmap_at("preceptor", ~ "Combined") %>%
    dmap_at("preceptor", factor) 

iq_range <- x %>%
    group_by(skill) %>%
    summarize_if(is.numeric, funs(q2 = quantile(., probs = 0.25), q3 = quantile(., probs = 0.75))) 

df <- rime %>%
    gather(skill, score, reporter:educator) %>%
    filter(!is.na(score)) %>%
    bind_rows(x) %>%
    dmap_at("skill", fct_inorder) %>%
    dmap_at("preceptor", as_factor) %>%
    mutate(preceptor = fct_reorder(preceptor, x = score, fun = median, .desc = TRUE)) %>%
    dmap_at("preceptor", ~ fct_relevel(.x, "Combined", after = Inf)) %>%
    inner_join(iq_range, by = "skill")

ggplot(data = df, aes(x = preceptor, y = score)) +
    geom_rect(aes(xmin = levels(df$preceptor)[nlevels(df$preceptor)], xmax = levels(df$preceptor)[1], ymin = q2, ymax = q3), fill = "light gray") +
    geom_boxplot() +
    facet_wrap(~ skill, ncol = 4, labeller = labeller(skill = capitalize)) +
    ylab("RIME Score") +
    xlab("") +
    labs(caption = "The shaded area represents the 25th to 75th percentile for all preceptors combined.") +
    coord_flip() +
    theme_bg() +
    theme(panel.border = element_rect(fill = NA, color = "light gray"), 
          strip.text.y = element_text(angle = 180))
```
